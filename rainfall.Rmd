# Rainfall analysis

Rainfall analysis inspired by https://github.com/engjen/rain_pdx


---


Load packages

```{r}
library(magrittr)
library(tidyverse)
library(ggthemes)
library(hrbrthemes)
```

Read rain gauge data from City of Portland Bureau of Environmental Services by way of USGS.

> Vernon School Rain Gage - 2044 NE. Killingsworth St.  
>  
> PROVISIONAL, UNCORRECTED RAW DATA FROM THE CITY OF PORTLAND HYDRA NETWORK.  
> Data are the number of tips of the rain gage bucket.  
> Each tip is 0.01 inches of rainfall.  
>  [`-`, missing data]  
> Dates and times are PACIFIC STANDARD TIME.  

Assume most recent day is incomplete and exclude.
Convert *tips* to inches.

```{r}
url <- "https://or.water.usgs.gov/non-usgs/bes/vernon.rain"
f <- tempfile()
download.file(url, f)
colNames <- read_lines(f, skip = 9, n_max = 1) %>% str_trim() %>% str_split("\\s+") %>% unlist()
L <- read_lines(f, skip = 11) %>% str_split("\\s+")
date <- sapply(L, function(x) x[1]) %>% as.Date(format = "%d-%b-%Y")
total <- sapply(L, function(x) x[2]) %>% as.numeric()
hourly <- sapply(L, function(x) x[3:26], simplify = FALSE) %>% do.call(rbind, .) %>% data.frame() %>% mutate_if(is.character, as.numeric)
names(hourly) <- paste0("x", colNames[3:26])
df <-
  tibble(date, hourly) %>%
  filter(date < max(date)) %>%
  pivot_longer(starts_with("x")) %>%
  mutate(hour = gsub("x", "", name) %>% as.integer()) %>%
  select(-name) %>%
  mutate(datetime = sprintf("%02d:00", hour) %>% paste(date, .) %>% as.POSIXlt(format = "%Y-%m-%d %H:%M")) %>%
  mutate(inches = value * 0.01) %>%
  select(-value)
head(df) %>% knitr::kable()
```

Plot the most recent $k$ years.
Assume current month is incomplete and exclude.

```{r}
k <- 4
maxYear <- year(max(date))
minYear <- maxYear - k
previousMonth <- month(today() %>% floor_date(unit = "month") - 1)
fudge <- -1 + (previousMonth - 1) / 12
G <-
  df %>%
  filter(max(date) - k * 365.25 <= date) %>%
  filter(!(year(date) == year(today()) & month(date) == month(today()))) %>%
  mutate(year = year(date) %>% factor(),
         monthday = sprintf("%d-%d-%d", maxYear, month(date), day(date)) %>% as.Date()) %>%
  mutate(unit = floor_date(monthday, unit = "month")) %>%
  group_by(year, unit) %>%
  summarize(inches = sum(inches)) %>%
  ungroup() %>%
  ggplot(aes(x = unit, y = inches)) +
    geom_line(aes(color = year), alpha = 1/2, size = 1) +
    scale_color_viridis_d("Year", direction = -1) +
    scale_x_date("", date_breaks = "month", date_labels = "%b") +
    scale_y_continuous("Inches\nof\nrainfall", transform = "sqrt") +
    coord_polar(start = -((previousMonth + fudge) / 12) * (2 * pi)) +
    theme_ipsum_ps() +
    theme(axis.title.y = element_text(angle = 0, hjust = 0.5, vjust = 0.83),
          panel.grid.minor.x = element_blank())
ggsave("rainfall.png", dpi = 300, units = "in", height = 4, width = 6)
```

![rainfall.png](rainfall.png)

Create `ts` object

```{r}
min <- min(df$date, na.rm = TRUE)
max <- max(df$date, na.rm = TRUE)
timeSeries <-
  df %>%
  group_by(date) %>%
  summarize(inches = sum(inches)) %>%
  ungroup() %>%
  ts(start = min, end = max)
```


---


Session information

```{r}
sessionInfo()
```
